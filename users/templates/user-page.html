{% extends 'base.html' %}

{% block content %}

<a href="http://127.0.0.1:8000/users/">&laquo; Back</a>

    <h1>[{{ users_id }}] {{ first_name }} {{ last_name }}</h1>    
    e-mail: {{ email }} | gender: {{ gender }} | ip: {{ ip_address }} <br/><br/>

<table id="table" border="2" style="float: left;">
    <caption>{{ user_id }} {{ first_name }} {{ last_name }} statistic</caption>
    <tr>
        {% comment %}<th class="active">user_id</th>{% endcomment %}
        <th class="active">date</th>
        <th class="active">page_views</th>
        <th class="active">clicks</th>
    </tr>
    {% for statistic in statistics %}
        {% if statistic.user_id|slugify == users_id|slugify %}
            <tr>
                {% comment %}<th>{{ statistic.user_id }}</a></th>{% endcomment %}
                <th id="statistic-data">{{ statistic.date }}</th>
                <th id="statistic-page-views">{{ statistic.page_views }}</th>
                <th id="statistic-clicks">{{ statistic.clicks }}</th>
            </tr>
        {% endif %}
    {% endfor %}
</table>

<script type="text/javascript">
    
    var index = 1;
    var statistic_data = [],
        statistic_page_views = [],
        statistic_clicks = [];

    try {
        while(true) {
            statistic_data.push(document.getElementById('table').rows[index].cells[0].innerHTML);
            statistic_page_views.push(document.getElementById('table').rows[index].cells[1].innerHTML);
            statistic_clicks.push(document.getElementById('table').rows[index].cells[2].innerHTML);
            index++;
        } 
    } catch(error) {}

</script>

<style>

    .axis path, .axis line {
        fill: none;
        stroke: #333;
    }
    .axis .grid-line {
        stroke: #000;
        stroke-opacity: 0.2;
    }
    .axis text {
        font: 10px Verdana;
    }

</style>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript">

    var data_year = [],
        data_month = [],
        data_day = [];

    for(var i=0; i<statistic_data.length; i++) {
        data_year.push(parseInt(statistic_data[i].slice(0, 4)));
        data_month.push(parseInt(statistic_data[i].slice(5, 7)));
        data_day.push(parseInt(statistic_data[i].slice(8, 11)));
    }

    var min_data = new Date(d3.min(data_year), d3.min(data_month), d3.min(data_day)),
        max_data = new Date(d3.max(data_year), d3.max(data_month), d3.max(data_day));

    var height = 450,
        width = 450,
        margin = 50,
        axisWidthX = width - 2 * margin,
        axisWidthY = height - 2 * margin,
        svg,
        data = [],
        data_plot_statistic_page_views = [],
        data_plot_statistic_clicks = [];

    for(var i=0; i<statistic_data.length; i++) {
        data_plot_statistic_page_views.push({x: new Date(data_year[i], data_month[i], data_day[i]), y: statistic_page_views[i]});
        data_plot_statistic_clicks.push({x: new Date(data_year[i], data_month[i], data_day[i]), y: statistic_clicks[i]});
    }

    createAxes(data_plot_statistic_page_views, 'page_views');
    createAxes(data_plot_statistic_clicks, 'clicks');

    function createAxes(data_array, title) {
        svg = d3.select("body")
            .append("svg")
            .attr("class", "axis")
            .attr("width", width)
            .attr("height", height);

        var scaleX = d3.time
            .scale()
            .domain([min_data, max_data])
            .range([0, axisWidthX]);

        var scaleY = d3.scale.linear()
            .domain([1000, 0])
            .range([0, axisWidthY]);

        for(i=0; i<data_array.length; i++) {
            data.push({x: scaleX(data_array[i].x)+margin, y: scaleY(data_array[i].y)+margin});
        }

        var axisX = d3.svg.axis() 
            .scale(scaleX) 
            .orient('bottom') 
            .ticks(5);

        var axisY = d3.svg.axis() 
            .scale(scaleY) 
            .orient('left') 

        
        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", "translate("+margin+","+(height-margin)+")")
            .call(axisX);

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", "translate("+margin+","+margin+")")
            .call(axisY);

        d3.selectAll("g.x-axis g.tick")
            .append("line") 
            .classed("grid-line", true) 
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", 0)
            .attr("y2", - (axisWidthY));

        d3.selectAll("g.y-axis g.tick")
            .append("line")
            .classed("grid-line", true)
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", axisWidthX)
            .attr("y2", 0);

        var line = d3.svg.line()
            .x(function(d){return d.x;})
            .y(function(d){return d.y;});

        svg.append("g").append("path")
            .attr("d", line(data))
            .style("stroke", "steelblue")
            .style("stroke-width", 2);

        var g = svg.append("g");

        g.append("path")
            .attr("d", line(data))
            .style("stroke", "steelblue")
            .style("stroke-width", 2);

        g.append("text")
            .attr("x", (width / 2))
            .attr("y", margin - 10 )
            .attr("text-anchor", "middle")
            .style("font-size", "22px")
            .text("Attitude chart [data/"+title+"]");

        g.append("text")
            .attr("x", margin + 11)
            .attr("y", margin - 11)
            .attr("text-anchor", "end")
            .style("font-size", "11px")
            .text(title);
        
        g.append("text")
            .attr("x", width - margin + 11)
            .attr("y", height - margin - 5)
            .attr("text-anchor", "end")
            .style("font-size", "11px")
            .text("data");

            data = [];
    }
    
</script>

{% endblock %}  